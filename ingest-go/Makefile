.PHONY: run build test clean docker-up docker-down

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
BINARY_NAME=ingest-go
VERSION?=1.0.0

# –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
run:
	go run main.go

build:
	go build -o $(BINARY_NAME) main.go

clean:
	rm -f $(BINARY_NAME)
	go clean

test:
	go test ./...

# Docker –∫–æ–º–∞–Ω–¥—ã
docker-up:
	docker-compose up -d mqtt

docker-down:
	docker-compose down

docker-logs:
	docker-compose logs -f

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
deps:
	go mod tidy
	go mod download

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
fmt:
	go fmt ./...

# –õ–∏–Ω—Ç–∏–Ω–≥
lint:
	golangci-lint run

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
check-connection:
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π..."
	@echo -n "MQTT (1883): "
	@nc -zv localhost 1883 2>&1 | grep -q "succeeded" && echo "success" || echo "error"
	@echo -n "PostgreSQL –ø–∞—Ä—Ç–Ω–µ—Ä–∞: "
	@timeout 2 psql $(POSTGRES_URL) -c "SELECT 1;" 2>&1 | grep -q "1 row" && echo "success" || echo "error"

# –ü–æ–º–æ—â—å
help:
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo "  make run           - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å"
	@echo "  make build         - –°–æ–±—Ä–∞—Ç—å –±–∏–Ω–∞—Ä–Ω–∏–∫"
	@echo "  make docker-up     - –ó–∞–ø—É—Å—Ç–∏—Ç—å MQTT –±—Ä–æ–∫–µ—Ä"
	@echo "  make docker-down   - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
	@echo "  make deps          - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
	@echo "  make check         - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
	@echo "  make clean         - –û—á–∏—Å—Ç–∏—Ç—å —Å–±–æ—Ä–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã"